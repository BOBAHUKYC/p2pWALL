<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé® P2P Wall - –ü–æ–ª–Ω–æ—Å—Ç—å—é –±—Ä–∞—É–∑–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #4a6fa5 0%, #3a4f8c 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px 25px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-badge.connected {
            background: #28a745;
            color: white;
        }

        .status-badge.disconnected {
            background: #dc3545;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: 600px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .control-panel {
            background: #f8f9fa;
            padding: 25px;
            border-right: 2px solid #e9ecef;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .control-group h3 {
            color: #4a6fa5;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ID Wall Card - –ù–û–í–´–ô –°–¢–ò–õ–¨ */
        .id-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .id-card .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .id-card .value {
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 5px;
        }

        /* –ö–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è */
        .copy-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .copy-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .copy-btn.copied {
            background: #28a745;
        }

        /* Input –≥—Ä—É–ø–ø—ã */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: monospace;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: #28a745;
        }

        .btn-primary:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
        }

        /* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞ */
        .post-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            height: 100px;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .file-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .file-inputs label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        .file-inputs label:hover {
            border-color: #667eea;
        }

        /* –°–ø–∏—Å–æ–∫ –ø–∏—Ä–æ–≤ */
        .peers-list {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            max-height: 200px;
            overflow-y: auto;
        }

        .peer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #f1f1f1;
        }

        .peer-item:last-child {
            border-bottom: none;
        }

        .peer-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* –°—Ç–µ–Ω–∞ —Å –ø–æ—Å—Ç–∞–º–∏ */
        .wall-container {
            padding: 25px;
            background: white;
            overflow-y: auto;
            max-height: 700px;
        }

        .wall {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .post {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .post:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-3px);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f1f1f1;
        }

        .post-id {
            font-family: monospace;
            background: #f8f9fa;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }

        .post-timestamp {
            color: #6c757d;
            font-size: 14px;
        }

        .post-text {
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .post-media {
            margin: 15px 0;
        }

        .post-image {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .post-audio {
            width: 100%;
            margin-top: 10px;
        }

        /* Magnet —Å—Å—ã–ª–∫–∏ –≤ –ø–æ—Å—Ç–∞—Ö */
        .magnet-link {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #dee2e6;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
        }

        .magnet-link .copy-magnet {
            display: inline-block;
            margin-left: 10px;
            padding: 3px 8px;
            background: #6c757d;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .magnet-link .copy-magnet:hover {
            background: #545b62;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–∞–≥–Ω–µ—Ç–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            color: #4a6fa5;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .full-magnet {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }

        /* QR –∫–æ–¥ */
        .qr-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        #qrCode {
            max-width: 200px;
            margin: 0 auto;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –ò–∫–æ–Ω–∫–∏ */
        .icon {
            font-size: 1.2em;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .copy-buttons {
                flex-direction: column;
            }
        }
		/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–æ–º */
		.post-controls {
			display: flex;
			gap: 10px;
			margin-top: 15px;
			padding-top: 15px;
			border-top: 1px solid #f1f1f1;
		}

		.post-control-btn {
			padding: 6px 12px;
			border: none;
			border-radius: 6px;
			background: #f8f9fa;
			color: #6c757d;
			font-size: 13px;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 5px;
			transition: all 0.3s;
		}

		.post-control-btn:hover {
			background: #e9ecef;
			transform: translateY(-1px);
		}

		.post-control-btn.delete {
			background: #f8d7da;
			color: #721c24;
		}

		.post-control-btn.delete:hover {
			background: #f5c6cb;
		}

		/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–ª–µ–µ—Ä–∞ */
		.audio-player {
			width: 100%;
			margin-top: 10px;
			border-radius: 8px;
			background: #f8f9fa;
			padding: 10px;
		}

		.audio-player audio {
			width: 100%;
			height: 40px;
		}

		.audio-info {
			display: flex;
			align-items: center;
			gap: 10px;
			margin-bottom: 8px;
		}

		.audio-icon {
			font-size: 20px;
		}

		.audio-title {
			font-size: 14px;
			color: #495057;
		}

		/* –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö */
		.cleanup-section {
			margin-top: 20px;
			padding: 15px;
			background: #fff3cd;
			border: 1px solid #ffeaa7;
			border-radius: 8px;
		}

		.cleanup-buttons {
			display: flex;
			gap: 10px;
			margin-top: 10px;
		}
		
		.cleanup-buttons, .input-group, .copy-buttons {
			flex-wrap:wrap;
		}
		
		.input-group > *, .btn-small, .cleanup-buttons > *{
			display:block;
			width:100%;
		}

		.cleanup-btn {
			padding: 8px 15px;
			border: none;
			border-radius: 6px;
			background: #dc3545;
			color: white;
			font-size: 14px;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 8px;
			transition: all 0.3s;
		}

		.cleanup-btn:hover {
			background: #c82333;
			transform: translateY(-2px);
		}

		.cleanup-btn.warning {
			background: #ffc107;
			color: #212529;
		}

		.cleanup-btn.warning:hover {
			background: #e0a800;
		}

		/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è */
		.confirm-modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.5);
			z-index: 1001;
			align-items: center;
			justify-content: center;
		}

		.confirm-content {
			background: white;
			padding: 30px;
			border-radius: 15px;
			max-width: 400px;
			width: 90%;
			text-align: center;
		}

		.confirm-buttons {
			display: flex;
			gap: 10px;
			margin-top: 20px;
			justify-content: center;
		}

		.confirm-btn {
			padding: 10px 20px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-weight: 600;
			transition: all 0.3s;
		}

		.confirm-btn.yes {
			background: #dc3545;
			color: white;
		}

		.confirm-btn.yes:hover {
			background: #c82333;
		}

		.confirm-btn.no {
			background: #6c757d;
			color: white;
		}

		.confirm-btn.no:hover {
			background: #545b62;
		}

		/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ */
		.audio-loading {
			text-align: center;
			padding: 10px;
			color: #6c757d;
			font-size: 14px;
		}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé® P2P Wall</h1>
            <p class="subtitle">–ü–æ–ª–Ω–æ—Å—Ç—å—é –±—Ä–∞—É–∑–µ—Ä–Ω–∞—è –¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–µ–Ω–∞</p>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <span>–°—Ç–∞—Ç—É—Å:</span>
                <span id="statusBadge" class="status-badge disconnected">–û—Ç–∫–ª—é—á–µ–Ω</span>
            </div>
            <div class="status-item">
                <span>üë• –ü–∏—Ä–æ–≤:</span>
                <span id="peerCount">0</span>
            </div>
            <div class="status-item">
                <span>üìù –ü–æ—Å—Ç–æ–≤:</span>
                <span id="postCount">0</span>
            </div>
            <div class="status-item">
                <span>üÜî ID —Å—Ç–µ–Ω—ã:</span>
                <span id="wallIdDisplay">–ù–µ —Å–æ–∑–¥–∞–Ω–∞</span>
            </div>
        </div>

        <div class="main-content">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <div class="control-panel">
                <div class="control-group">
                    <h3>üÜî ID –°–¢–ï–ù–´</h3>
                    <div class="id-card">
                        <div class="label">–í–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å—Ç–µ–Ω—ã:</div>
                        <div class="value" id="wallIdFull">–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ç–µ–Ω—É</div>
                        <div class="copy-buttons">
                            <button onclick="copyWallId()" class="copy-btn" id="copyWallIdBtn">
                                <span class="icon">üìã</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID
                            </button>
                            <button onclick="copyMagnet()" class="copy-btn" id="copyMagnetBtn">
                                <span class="icon">üîó</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å Magnet
                            </button>
                            <button onclick="showShareModal()" class="copy-btn">
                                <span class="icon">üì§</span> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                            </button>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                    <div class="input-group">
                        <input type="text" id="wallInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ ID –∏–ª–∏ Magnet —Å—Å—ã–ª–∫—É">
                        <button onclick="joinWall()" class="btn btn-primary">
                            <span class="icon">üîó</span> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                        </button>
                    </div>
                    <button onclick="createWall()" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                        <span class="icon">‚ûï</span> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç–µ–Ω—É
                    </button>
                    <button onclick="generateInviteLink()" class="btn btn-info btn-small">
                        <span class="icon">üîó</span> –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
                    </button>
                </div>

                <div class="control-group">
                    <h3>‚ûï –ù–æ–≤—ã–π –ø–æ—Å—Ç</h3>
                    <div class="post-form">
                        <textarea id="postText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..."></textarea>
                        <div class="file-inputs">
                            <label>
                                <input type="file" id="imageInput" accept="image/*" style="display: none;">
                                <span class="icon">üñºÔ∏è</span> –î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                            </label>
                            <label>
                                <input type="file" id="audioInput" accept="audio/*" style="display: none;">
                                <span class="icon">üéµ</span> –î–æ–±–∞–≤–∏—Ç—å –∞—É–¥–∏–æ
                            </label>
                        </div>
                        <button onclick="addPost()" class="btn btn-primary" style="width: 100%;">
                            <span class="icon">üì®</span> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üë• –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–∏—Ä—ã</h3>
                    <div class="peers-list" id="peersList">
                        <div class="loading">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∏—Ä–æ–≤</div>
                    </div>
                    <button onclick="refreshPeers()" class="btn btn-secondary btn-small" style="margin-top: 10px;">
                        <span class="icon">üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    </button>
                </div>
				
				<div class="control-group">
					<h3>üóëÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
					<div class="cleanup-section">
						<p><strong>‚ö†Ô∏è –û—Å—Ç–æ—Ä–æ–∂–Ω–æ!</strong> –≠—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
						<div class="cleanup-buttons">
							<button onclick="showClearDataConfirm()" class="cleanup-btn warning">
								<span class="icon">üßπ</span> –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
							</button>
							<button onclick="showDeleteWallConfirm()" class="cleanup-btn">
								<span class="icon">üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç–µ–Ω—É
							</button>
						</div>
						<p style="margin-top: 10px; font-size: 12px; color: #666;">
							–û—á–∏—Å—Ç–∫–∞ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–∞—à–µ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞, –Ω–æ –Ω–µ –∑–∞—Ç—Ä–æ–Ω–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.
						</p>
					</div>
				</div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - —Å—Ç–µ–Ω–∞ -->
            <div class="wall-container">
                <div id="messageArea"></div>
                <div id="wallContent">
                    <div class="loading">
                        <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ P2P Wall! üé®</h3>
                        <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Å—Ç–µ–Ω—É –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π.</p>
                        <div class="spinner"></div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ P2P —Å–∏—Å—Ç–µ–º—ã...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–∞–≥–Ω–µ—Ç–∞ -->
    <div id="magnetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Ç–µ–Ω–æ–π</h3>
                <button onclick="closeModal()" class="close-modal">&times;</button>
            </div>
            
            <div class="full-magnet" id="fullMagnetDisplay">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
            
            <div class="copy-buttons" style="margin: 20px 0;">
                <button onclick="copyFullMagnet()" class="copy-btn" id="copyFullMagnetBtn">
                    <span class="icon">üìã</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å Magnet —Å—Å—ã–ª–∫—É
                </button>
                <button onclick="copyInviteLink()" class="copy-btn" id="copyInviteLinkBtn">
                    <span class="icon">üîó</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
                </button>
            </div>
            
            <div class="qr-container">
                <h4>üì± QR-–∫–æ–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</h4>
                <canvas id="qrCode"></canvas>
                <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</p>
            </div>
            
            <div style="margin-top: 20px;">
                <h4>üìù –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è:</h4>
                <ol style="padding-left: 20px; margin-top: 10px;">
                    <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ Magnet —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É</li>
                    <li>–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É</li>
                    <li>–ò–ª–∏ –ø–æ–ø—Ä–æ—Å–∏—Ç–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥</li>
                    <li>–ü–æ–ª—É—á–∞—Ç–µ–ª—å –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –≤ –ø–æ–ª–µ "ID —Å—Ç–µ–Ω—ã"</li>
                    <li>–ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è"</li>
                </ol>
            </div>
            
            <button onclick="closeModal()" class="btn btn-secondary" style="width: 100%; margin-top: 20px;">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —á–µ—Ä–µ–∑ CDN -->
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@1.8.4/webtorrent.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let wallClient = null;
        let currentWall = null;
        let wallId = null;
        let wallMagnet = null;
        let posts = [];
        let peers = new Map();
        let activeTorrents = new Map();
        let inviteLink = null;
		let pendingAction = null;
		let pendingPostId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            initializeWallSystem();
            loadLastWall();
        });

        function initializeWallSystem() {
            try {
                // –°–æ–∑–¥–∞–µ–º WebTorrent –∫–ª–∏–µ–Ω—Ç
                wallClient = new WebTorrent();
                
                // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–∏—Ä–æ–≤
                wallClient.on('torrent', (torrent) => {
                    console.log('–ù–æ–≤—ã–π —Ç–æ—Ä—Ä–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω:', torrent.name);
                    activeTorrents.set(torrent.infoHash, torrent);
                    updatePeersList();
                });
                
                updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
                showMessage('‚úÖ P2P —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showMessage('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ P2P —Å–∏—Å—Ç–µ–º—ã', 'error');
            }
        }

        function createWall() {
            try {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —Å—Ç–µ–Ω—ã
                wallId = generateWallId();
                
                // –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–µ–Ω—ã
                currentWall = {
                    id: wallId,
                    name: '–ú–æ—è P2P —Å—Ç–µ–Ω–∞',
                    created: Date.now(),
                    posts: [],
                    peers: [],
                    lastUpdate: Date.now()
                };
                
                // –°–æ–∑–¥–∞–µ–º magnet —Å—Å—ã–ª–∫—É
                wallMagnet = `wall:${wallId}:${Date.now()}`;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                saveWallToStorage();
                
                // –°–æ–∑–¥–∞–µ–º —Ç–æ—Ä—Ä–µ–Ω—Ç –¥–ª—è —Å—Ç–µ–Ω—ã
                createWallTorrent();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                updateWallInfo();
                updateStatus('–°—Ç–µ–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞');
                showMessage('‚úÖ –°—Ç–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                setTimeout(() => {
                    showShareModal();
                }, 500);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–µ–Ω—ã:', error);
                showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–µ–Ω—ã', 'error');
            }
        }

        function generateWallId() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substr(2, 9);
            return `wall_${timestamp}_${random}`;
        }

        async function createWallTorrent() {
			if (!currentWall || !wallClient) return;

			// 1. –£–î–ê–õ–Ø–ï–ú –°–¢–ê–†–´–ô –¢–û–†–†–ï–ù–¢ –°–¢–ï–ù–´, –ï–°–õ–ò –û–ù –ï–°–¢–¨
			if (window.existingWallTorrent) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏
				console.log('–£–¥–∞–ª—è—é —Å—Ç–∞—Ä—ã–π —Ç–æ—Ä—Ä–µ–Ω—Ç —Å—Ç–µ–Ω—ã...');
				try {
					wallClient.remove(window.existingWallTorrent);
					activeTorrents.delete(window.existingWallTorrent.infoHash);
				} catch(e) { console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ—Ä—Ä–µ–Ω—Ç–∞:', e); }
				window.existingWallTorrent = null;
			}

			try {
				const wallData = JSON.stringify(currentWall, null, 2);
				const blob = new Blob([wallData], { type: 'application/json' });
				
				wallClient.seed(blob, {
					name: `P2P_Wall_${wallId}`,
					comment: 'Decentralized wall using BitTorrent',
					createdBy: 'P2P-Wall-App',
					announce: [
						'wss://tracker.openwebtorrent.com',
						'wss://tracker.files.fm:7073/announce',
						'wss://tracker.webtorrent.dev'
					]
				}, (torrent) => {
					if (!torrent) {
						console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–æ—Ä—Ä–µ–Ω—Ç —Å—Ç–µ–Ω—ã');
						return;
					}
					
					// 2. –°–û–•–†–ê–ù–Ø–ï–ú –°–°–´–õ–ö–£ –ù–ê –ù–û–í–´–ô –¢–û–†–†–ï–ù–¢
					window.existingWallTorrent = torrent;
					activeTorrents.set(torrent.infoHash, torrent);
					wallMagnet = torrent.magnetURI;
					
					console.log('‚úÖ –¢–æ—Ä—Ä–µ–Ω—Ç —Å—Ç–µ–Ω—ã —Å–æ–∑–¥–∞–Ω:', torrent.infoHash);
				});
			} catch (error) {
				console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ—Ä—Ä–µ–Ω—Ç–∞:', error);
			}
		}

        function joinWall(id = null) {
            try {
                const input = id || document.getElementById('wallInput').value.trim();
                
                if (!input) {
                    showMessage('‚ùå –í–≤–µ–¥–∏—Ç–µ ID —Å—Ç–µ–Ω—ã –∏–ª–∏ Magnet —Å—Å—ã–ª–∫—É', 'error');
                    return;
                }
                
                updateStatus('–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
                
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–æ—Ä—Ä–µ–Ω—Ç—ã
                clearOldTorrents();
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤–≤–æ–¥–∞ (ID –∏–ª–∏ Magnet)
                if (input.startsWith('magnet:')) {
                    // –≠—Ç–æ magnet —Å—Å—ã–ª–∫–∞
                    joinViaMagnet(input);
                } else if (input.startsWith('wall:')) {
                    // –≠—Ç–æ ID —Å—Ç–µ–Ω—ã
                    wallId = input;
                    joinViaId();
                } else {
                    // –ü—Ä–æ–±—É–µ–º –∫–∞–∫ ID
                    wallId = input;
                    joinViaId();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', error);
                showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ —Å—Ç–µ–Ω–µ', 'error');
                updateStatus('–û—à–∏–±–∫–∞');
            }
        }

		function joinViaMagnet(magnet) {
			console.log('–ü—ã—Ç–∞—é—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ Magnet:', magnet);
			updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ P2P —Å–µ—Ç–∏...');
			showLoading('–ü–æ–∏—Å–∫ —Å—Ç–µ–Ω—ã –≤ P2P —Å–µ—Ç–∏...');

			wallClient.add(magnet, { maxWebConns: 20 }, (torrent) => {
				if (!torrent) {
					console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—Ä—Ä–µ–Ω—Ç –ø–æ —Å—Å—ã–ª–∫–µ:', magnet);
					showMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Magnet-—Å—Å—ã–ª–∫—É.', 'error');
					updateStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
					showLoading('–°—Ç–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
					return;
				}

				console.log('–¢–æ—Ä—Ä–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω:', torrent.name);
				activeTorrents.set(torrent.infoHash, torrent);

				// –í–ê–ñ–ù–û: –ñ–¥–µ–º, –ø–æ–∫–∞ —Ç–æ—Ä—Ä–µ–Ω—Ç –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –∫ —á—Ç–µ–Ω–∏—é —Ñ–∞–π–ª–æ–≤
				torrent.on('ready', () => {
					console.log('–¢–æ—Ä—Ä–µ–Ω—Ç –≥–æ—Ç–æ–≤, –∏—â–µ–º —Ñ–∞–π–ª metadata...');
					
					const metadataFile = torrent.files.find(f => f.name.endsWith('.json') || f.name.includes('metadata'));
					if (!metadataFile) {
						showMessage('‚ùå –í —Ç–æ—Ä—Ä–µ–Ω—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö —Å—Ç–µ–Ω—ã.', 'error');
						updateStatus('–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö');
						return;
					}

					console.log('–§–∞–π–ª –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –Ω–∞–π–¥–µ–Ω:', metadataFile.name);
					metadataFile.getBuffer((err, buffer) => {
						if (err) {
							console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', err);
							showMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ç–µ–Ω—ã.', 'error');
							return;
						}

						try {
							const wallData = JSON.parse(buffer.toString());
							console.log('–î–∞–Ω–Ω—ã–µ —Å—Ç–µ–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü–æ—Å—Ç–æ–≤:', wallData.posts?.length || 0);
							
							// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
							loadWallData(wallData, magnet);
							showMessage('‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ —Å—Ç–µ–Ω–µ!', 'success');
							updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω');
							
						} catch (parseError) {
							console.error('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ JSON:', parseError);
							showMessage('‚ùå –î–∞–Ω–Ω—ã–µ —Å—Ç–µ–Ω—ã –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã.', 'error');
						}
					});
				});

				// –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ —Å–ª—É—à–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI
				torrent.on('download', (bytes) => {
					console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${(torrent.progress * 100).toFixed(1)}%`);
					// –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä, –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç–µ –µ–≥–æ
				});

				torrent.on('error', (err) => {
					console.error('–û—à–∏–±–∫–∞ –≤ —Ç–æ—Ä—Ä–µ–Ω—Ç–µ:', err);
					showMessage('‚ùå –û—à–∏–±–∫–∞ –≤ P2P-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏.', 'error');
				});
			});
		}

        function joinViaId() {
            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ—Ä—Ä–µ–Ω—Ç
            const existingTorrent = Array.from(activeTorrents.values())
                .find(t => t.name.includes(wallId));
            
            if (existingTorrent) {
                loadWallFromTorrent(existingTorrent);
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø–æ–∏—Å–∫
                const searchMagnet = `magnet:?xt=urn:btih:${wallId}&dn=P2P_Wall&tr=wss://tracker.openwebtorrent.com`;
                joinViaMagnet(searchMagnet);
            }
        }

        function loadWallData(wallData, magnet = null) {
            currentWall = wallData;
            wallId = wallData.id;
            wallMagnet = magnet;
            posts = wallData.posts || [];
            
            saveWallToStorage();
            updateWallInfo();
            renderWall();
            updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω');
            showMessage('‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ —Å—Ç–µ–Ω–µ!', 'success');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–∏—Ä–æ–≤
            updatePeersList();
        }

        function addPost() {
            try {
                const text = document.getElementById('postText').value.trim();
                const imageFile = document.getElementById('imageInput').files[0];
                const audioFile = document.getElementById('audioInput').files[0];
                
                if (!text && !imageFile && !audioFile) {
                    showMessage('‚ùå –î–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–∞–π–ª', 'error');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç
                const post = {
                    id: generatePostId(),
                    timestamp: Date.now(),
                    text: text || null,
                    author: '–í—ã',
                    magnet: null
                };
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–µ–¥–∏–∞ —Ñ–∞–π–ª—ã
                const processPromises = [];
                
                if (imageFile) {
                    processPromises.push(
                        processFile(imageFile, 'image').then(data => {
                            post.image = data;
                            post.magnet = createPostTorrent(post);
                        })
                    );
                } else if (audioFile) {
                    processPromises.push(
                        processFile(audioFile, 'audio').then(data => {
                            post.audio = data;
                            post.magnet = createPostTorrent(post);
                        })
                    );
                } else {
                    post.magnet = createPostTorrent(post);
                }
                
                // –ñ–¥–µ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤
                Promise.all(processPromises).then(() => {
                    savePost(post);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞:', error);
                showMessage('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞', 'error');
            }
        }

        function generatePostId() {
            return `post_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
        }

        function processFile(file, type) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve({
                        type: type,
                        data: e.target.result,
                        name: file.name,
                        size: file.size,
                        mime: file.type
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        function createPostTorrent(post) {
			// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ–∑–¥–∞–Ω –ª–∏ —É–∂–µ —Ç–æ—Ä—Ä–µ–Ω—Ç –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞
			const existingTorrent = Array.from(activeTorrents.values())
				.find(t => t.name.includes(post.id));
			if (existingTorrent) {
				console.log('–¢–æ—Ä—Ä–µ–Ω—Ç –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:', post.id);
				return existingTorrent.magnetURI; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Å—ã–ª–∫—É
			}
            try {
                const postData = JSON.stringify(post);
                const blob = new Blob([postData], { type: 'application/json' });
                
                let magnet = null;
                
                wallClient.seed(blob, {
                    name: `post_${post.id}.json`,
                    announce: [
                        'wss://tracker.openwebtorrent.com',
                        'wss://tracker.btorrent.xyz'
                    ]
                }, (torrent) => {
                    if (torrent) {
                        magnet = torrent.magnetURI;
                        console.log('–ü–æ—Å—Ç —Ä–∞–∑–¥–∞–µ—Ç—Å—è:', magnet);
                    }
                });
                
                return magnet;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ—Ä—Ä–µ–Ω—Ç–∞:', error);
                return null;
            }
        }

        function savePost(post) {
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å—Ç
            posts.unshift(post);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–µ–Ω—É
            if (currentWall) {
                currentWall.posts = posts;
                currentWall.lastUpdate = Date.now();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—Ä—Ä–µ–Ω—Ç —Å—Ç–µ–Ω—ã
                updateWallTorrent();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º
                saveWallToStorage();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                renderWall();
                updateWallInfo();
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('postText').value = '';
                document.getElementById('imageInput').value = '';
                document.getElementById('audioInput').value = '';
                
                showMessage('‚úÖ –ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –∏ —Ä–∞–∑–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ P2P!', 'success');
            }
        }

        function updateWallTorrent() {
            if (!currentWall || !wallClient) return;
            
            try {
                // –ù–∞—Ö–æ–¥–∏–º —Ç–æ—Ä—Ä–µ–Ω—Ç —Å—Ç–µ–Ω—ã
                const wallTorrent = Array.from(activeTorrents.values())
                    .find(t => t.name.includes('P2P_Wall'));
                
                if (wallTorrent) {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ç–æ—Ä—Ä–µ–Ω—Ç
                    wallClient.remove(wallTorrent);
                    activeTorrents.delete(wallTorrent.infoHash);
                }
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ—Ä—Ä–µ–Ω—Ç —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                createWallTorrent();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ—Ä—Ä–µ–Ω—Ç–∞:', error);
            }
        }

        function renderWall() {
            const wallContent = document.getElementById('wallContent');
            
            if (posts.length === 0) {
                wallContent.innerHTML = `
                    <div class="loading">
                        <h3>üé® –°—Ç–µ–Ω–∞ –ø—É—Å—Ç–∞</h3>
                        <p>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –¥–æ–±–∞–≤–∏—Ç –ø–æ—Å—Ç!</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="wall">';
            
            posts.forEach(post => {
				// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–µ–¥–∏–∞
				const mediaContent = post.image 
					? `<div class="post-media"><img src="${post.image.data}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" class="post-image"></div>`
					: post.audio 
					? createAudioPlayer(post.audio)
					: '';
				
				// –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö –ø–æ—Å—Ç–æ–≤)
				const controls = post.author === '–í—ã' ? `
					<div class="post-controls">
						<button onclick="showDeletePostConfirm('${post.id}')" class="post-control-btn delete">
							<span class="icon">üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å
						</button>
						<button onclick="sharePost('${post.id}')" class="post-control-btn">
							<span class="icon">üì§</span> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
						</button>
					</div>
				` : '';
				
				html += `
					<div class="post" data-post-id="${post.id}">
						<div class="post-header">
							<div class="post-id">${post.author || '–ê–Ω–æ–Ω–∏–º'}</div>
							<div class="post-timestamp">${formatDate(post.timestamp)}</div>
						</div>
						${post.text ? `<div class="post-text">${post.text}</div>` : ''}
						${mediaContent}
						${post.magnet ? `
							<div class="magnet-link">
								üîó P2P —Å—Å—ã–ª–∫–∞: ${post.magnet.substring(0, 50)}...
								<span class="copy-magnet" onclick="copyToClipboard('${post.magnet}', '‚úÖ Magnet —Å—Å—ã–ª–∫–∞ –ø–æ—Å—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!')">
									–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
								</span>
							</div>
						` : ''}
						${controls}
					</div>
				`;
			});
            
            html += '</div>';
            wallContent.innerHTML = html;
        }

        // –§–£–ù–ö–¶–ò–ò –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø –ò –ü–û–î–ï–õ–ò–¢–¨–°–Ø
        function copyWallId() {
            if (!wallId) {
                showMessage('‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ç–µ–Ω—É', 'error');
                return;
            }
            
            copyToClipboard(wallId, '‚úÖ ID —Å—Ç–µ–Ω—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
            const btn = document.getElementById('copyWallIdBtn');
            btn.classList.add('copied');
            btn.innerHTML = '<span class="icon">‚úì</span> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = '<span class="icon">üìã</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID';
            }, 2000);
        }

        function copyMagnet() {
            if (!wallMagnet) {
                showMessage('‚ùå –ù–µ—Ç Magnet —Å—Å—ã–ª–∫–∏ –¥–ª—è —ç—Ç–æ–π —Å—Ç–µ–Ω—ã', 'error');
                return;
            }
            
            copyToClipboard(wallMagnet, '‚úÖ Magnet —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            
            const btn = document.getElementById('copyMagnetBtn');
            btn.classList.add('copied');
            btn.innerHTML = '<span class="icon">‚úì</span> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = '<span class="icon">üîó</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å Magnet';
            }, 2000);
        }

        function copyFullMagnet() {
            if (!wallMagnet) {
                showMessage('‚ùå –ù–µ—Ç Magnet —Å—Å—ã–ª–∫–∏', 'error');
                return;
            }
            
            copyToClipboard(wallMagnet, '‚úÖ –ü–æ–ª–Ω–∞—è Magnet —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            
            const btn = document.getElementById('copyFullMagnetBtn');
            btn.classList.add('copied');
            btn.innerHTML = '<span class="icon">‚úì</span> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = '<span class="icon">üìã</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å Magnet —Å—Å—ã–ª–∫—É';
            }, 2000);
        }

		function sharePost(postId) {
			const post = posts.find(p => p.id === postId);
			if (!post) {
				showMessage('‚ùå –ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
				return;
			}
			
			const shareText = post.text ? `–ü–æ—Å—Ç: ${post.text.substring(0, 100)}...` : '–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–æ—Å—Ç —Å P2P Wall';
			const shareUrl = post.magnet || generateInviteLink() || window.location.href;
			
			if (navigator.share) {
				navigator.share({
					title: 'P2P Wall - –ü–æ—Å—Ç',
					text: shareText,
					url: shareUrl
				}).then(() => {
					showMessage('‚úÖ –ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!', 'success');
				}).catch(error => {
					console.error('–û—à–∏–±–∫–∞ —à–µ—Ä–∏–Ω–≥–∞:', error);
					copyToClipboard(shareUrl, '‚úÖ –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
				});
			} else {
				copyToClipboard(shareUrl, '‚úÖ –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
			}
		}

        function copyInviteLink() {
            generateInviteLink();
            
            if (!inviteLink) {
                showMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É', 'error');
                return;
            }
            
            copyToClipboard(inviteLink, '‚úÖ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            
            const btn = document.getElementById('copyInviteLinkBtn');
            btn.classList.add('copied');
            btn.innerHTML = '<span class="icon">‚úì</span> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = '<span class="icon">üîó</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É';
            }, 2000);
        }

        function copyToClipboard(text, successMessage) {
            navigator.clipboard.writeText(text)
                .then(() => {
                    showMessage(successMessage, 'success');
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showMessage(successMessage, 'success');
                });
        }

        function showShareModal() {
            if (!wallId) {
                showMessage('‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ç–µ–Ω—É', 'error');
                return;
            }
            
            const modal = document.getElementById('magnetModal');
            const display = document.getElementById('fullMagnetDisplay');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            display.textContent = wallMagnet || '–ó–∞–≥—Ä—É–∑–∫–∞ Magnet —Å—Å—ã–ª–∫–∏...';
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥
            generateQRCode();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            modal.style.display = 'flex';
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
            generateInviteLink();
        }

        function closeModal() {
            const modal = document.getElementById('magnetModal');
            modal.style.display = 'none';
        }

        function generateInviteLink() {
            if (!wallId) return;
            
            // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
            const currentUrl = window.location.href.split('?')[0];
            inviteLink = `${currentUrl}?join=${encodeURIComponent(wallMagnet)}&t=${Date.now()}`;
            
            return inviteLink;
        }

        function generateQRCode() {
            const canvas = document.getElementById('qrCode');
            const qrData = wallMagnet || generateInviteLink() || window.location.href;
            
            if (!qrData) return;
            
            // –û—á–∏—â–∞–µ–º canvas
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –°–æ–∑–¥–∞–µ–º QR-–∫–æ–¥
            const qr = new QRious({
                element: canvas,
                value: qrData,
                size: 200,
                level: 'H'
            });
        }

        function updateWallInfo() {
            // –û–±–Ω–æ–≤–ª—è–µ–º ID —Å—Ç–µ–Ω—ã
            document.getElementById('wallIdDisplay').textContent = wallId 
                ? wallId.substring(0, 15) + '...' 
                : '–ù–µ —Å–æ–∑–¥–∞–Ω–∞';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π ID
            document.getElementById('wallIdFull').textContent = wallId || '–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ç–µ–Ω—É';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            document.getElementById('postCount').textContent = posts.length;
            document.getElementById('peerCount').textContent = countPeers();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            if (wallId && !document.getElementById('wallInput').value) {
                document.getElementById('wallInput').value = wallId;
            }
        }

        function countPeers() {
            let totalPeers = 0;
            activeTorrents.forEach(torrent => {
                totalPeers += torrent.numPeers;
            });
            return totalPeers;
        }

        function updatePeersList() {
            const peersList = document.getElementById('peersList');
            const peerCount = countPeers();
            
            if (peerCount === 0) {
                peersList.innerHTML = '<div class="loading">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∏—Ä–æ–≤</div>';
                return;
            }
            
            let html = '';
            let peerIndex = 1;
            
            activeTorrents.forEach(torrent => {
                torrent.wires.forEach((wire, index) => {
                    if (wire.connected) {
                        const peerId = `peer_${peerIndex}`;
                        html += `
                            <div class="peer-item">
                                <div class="peer-avatar">${peerIndex}</div>
                                <div>–ü–∏—Ä #${peerIndex}</div>
                                <div style="margin-left: auto; font-size: 12px; color: #28a745;">
                                    ‚óè –ê–∫—Ç–∏–≤–µ–Ω
                                </div>
                            </div>
                        `;
                        peerIndex++;
                    }
                });
            });
            
            peersList.innerHTML = html || '<div class="loading">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</div>';
        }

        function refreshPeers() {
            updatePeersList();
            showMessage('üîÑ –°–ø–∏—Å–æ–∫ –ø–∏—Ä–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω', 'info');
        }

        function clearOldTorrents() {
            activeTorrents.forEach(torrent => {
                if (torrent && wallClient) {
                    wallClient.remove(torrent);
                }
            });
            activeTorrents.clear();
        }

        function loadLastWall() {
            const lastWallId = localStorage.getItem('last_wall_id');
            if (lastWallId) {
                const savedWall = localStorage.getItem('p2p_wall_' + lastWallId);
                if (savedWall) {
                    try {
                        const wallData = JSON.parse(savedWall);
                        loadWallData(wallData);
                        showMessage('üìÇ –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–µ–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ –ø–∞–º—è—Ç–∏', 'info');
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    }
                }
            }
        }

        function saveWallToStorage() {
            if (currentWall) {
                localStorage.setItem('p2p_wall_' + wallId, JSON.stringify(currentWall));
                localStorage.setItem('last_wall_id', wallId);
            }
        }

        function updateStatus(status) {
            const badge = document.getElementById('statusBadge');
            if (status.includes('–û—à–∏–±–∫–∞') || status.includes('–û—Ç–∫–ª—é—á–µ–Ω')) {
                badge.className = 'status-badge disconnected';
                badge.textContent = '–û—Ç–∫–ª—é—á–µ–Ω';
            } else {
                badge.className = 'status-badge connected';
                badge.textContent = status;
            }
        }

        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }
		
		// –§—É–Ω–∫—Ü–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
		function showDeletePostConfirm(postId) {
			pendingAction = 'delete_post';
			pendingPostId = postId;
			
			const post = posts.find(p => p.id === postId);
			const message = post ? `–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç "${post.text?.substring(0, 50) || '–±–µ–∑ —Ç–µ–∫—Å—Ç–∞'}"?` : '–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?';
			
			document.getElementById('confirmTitle').textContent = '–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞';
			document.getElementById('confirmMessage').textContent = message;
			document.getElementById('confirmModal').style.display = 'flex';
		}

		function showClearDataConfirm() {
			pendingAction = 'clear_data';
			pendingPostId = null;
			
			document.getElementById('confirmTitle').textContent = '–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö';
			document.getElementById('confirmMessage').textContent = '–û—á–∏—Å—Ç–∏—Ç—å –í–°–ï –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –≤–∞—à–∏ —Å—Ç–µ–Ω—ã –∏ –ø–æ—Å—Ç—ã.';
			document.getElementById('confirmModal').style.display = 'flex';
		}

		function showDeleteWallConfirm() {
			if (!wallId) {
				showMessage('‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–µ–Ω—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
				return;
			}
			
			pendingAction = 'delete_wall';
			pendingPostId = null;
			
			document.getElementById('confirmTitle').textContent = '–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–µ–Ω—ã';
			document.getElementById('confirmMessage').textContent = `–£–¥–∞–ª–∏—Ç—å —Å—Ç–µ–Ω—É "${wallId}"? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –µ—ë —Ç–æ–ª—å–∫–æ —Å –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.`;
			document.getElementById('confirmModal').style.display = 'flex';
		}

		function confirmAction(confirmed) {
			const modal = document.getElementById('confirmModal');
			modal.style.display = 'none';
			
			if (!confirmed) {
				pendingAction = null;
				pendingPostId = null;
				return;
			}
			
			switch(pendingAction) {
				case 'delete_post':
					deletePost(pendingPostId);
					break;
				case 'clear_data':
					clearLocalData();
					break;
				case 'delete_wall':
					deleteCurrentWall();
					break;
			}
			
			pendingAction = null;
			pendingPostId = null;
		}

		// –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞
		function deletePost(postId) {
			try {
				// –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –ø–æ—Å—Ç–∞
				const postIndex = posts.findIndex(p => p.id === postId);
				if (postIndex === -1) {
					showMessage('‚ùå –ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
					return;
				}
				
				// –£–¥–∞–ª—è–µ–º –ø–æ—Å—Ç –∏–∑ –º–∞—Å—Å–∏–≤–∞
				const deletedPost = posts.splice(postIndex, 1)[0];
				
				// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–µ–Ω—É
				if (currentWall) {
					currentWall.posts = posts;
					currentWall.lastUpdate = Date.now();
					
					// –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—Ä—Ä–µ–Ω—Ç —Å—Ç–µ–Ω—ã
					updateWallTorrent();
					
					// –°–æ—Ö—Ä–∞–Ω—è–µ–º
					saveWallToStorage();
					
					// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
					renderWall();
					updateWallInfo();
					
					// –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å —Ç–æ—Ä—Ä–µ–Ω—Ç –ø–æ—Å—Ç–∞
					removePostTorrent(deletedPost);
					
					showMessage('‚úÖ –ü–æ—Å—Ç —É–¥–∞–ª—ë–Ω', 'success');
				}
				
			} catch (error) {
				console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞:', error);
				showMessage('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞', 'error');
			}
		}

		function removePostTorrent(post) {
			if (!post || !wallClient) return;
			
			try {
				// –ò—â–µ–º —Ç–æ—Ä—Ä–µ–Ω—Ç –ø–æ—Å—Ç–∞
				const postTorrent = Array.from(activeTorrents.values())
					.find(t => t.name.includes(post.id));
				
				if (postTorrent) {
					wallClient.remove(postTorrent);
					activeTorrents.delete(postTorrent.infoHash);
					console.log('–¢–æ—Ä—Ä–µ–Ω—Ç –ø–æ—Å—Ç–∞ —É–¥–∞–ª—ë–Ω:', post.id);
				}
			} catch (error) {
				console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ—Ä—Ä–µ–Ω—Ç–∞:', error);
			}
		}

		// –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ç–µ–Ω—ã
		function deleteCurrentWall() {
			try {
				if (!wallId) {
					showMessage('‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–µ–Ω—ã', 'error');
					return;
				}
				
				// –£–¥–∞–ª—è–µ–º –∏–∑ localStorage
				localStorage.removeItem('p2p_wall_' + wallId);
				localStorage.removeItem('last_wall_id');
				
				// –û—á–∏—â–∞–µ–º –≤—Å–µ —Ç–æ—Ä—Ä–µ–Ω—Ç—ã —ç—Ç–æ–π —Å—Ç–µ–Ω—ã
				clearWallTorrents();
				
				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
				wallId = null;
				wallMagnet = null;
				currentWall = null;
				posts = [];
				activeTorrents.clear();
				
				// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
				updateWallInfo();
				renderWall();
				updateStatus('–°—Ç–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∞');
				
				// –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
				document.getElementById('wallInput').value = '';
				
				showMessage('‚úÖ –°—Ç–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∞ —Å –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', 'success');
				
			} catch (error) {
				console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–µ–Ω—ã:', error);
				showMessage('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–µ–Ω—ã', 'error');
			}
		}

		function clearWallTorrents() {
			try {
				activeTorrents.forEach(torrent => {
					if (wallClient) {
						wallClient.remove(torrent);
					}
				});
				activeTorrents.clear();
			} catch (error) {
				console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ç–æ—Ä—Ä–µ–Ω—Ç–æ–≤:', error);
			}
		}

		// –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
		function clearLocalData() {
			try {
				// –û—á–∏—â–∞–µ–º localStorage
				localStorage.clear();
				
				// –û—á–∏—â–∞–µ–º –≤—Å–µ —Ç–æ—Ä—Ä–µ–Ω—Ç—ã
				if (wallClient) {
					wallClient.torrents.forEach(torrent => {
						wallClient.remove(torrent);
					});
				}
				activeTorrents.clear();
				
				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
				wallId = null;
				wallMagnet = null;
				currentWall = null;
				posts = [];
				inviteLink = null;
				
				// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
				updateWallInfo();
				renderWall();
				updateStatus('–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
				
				// –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
				document.getElementById('wallInput').value = '';
				document.getElementById('postText').value = '';
				
				showMessage('‚úÖ –í—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'success');
				
			} catch (error) {
				console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
				showMessage('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
			}
		}

		// –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–ª–µ–µ—Ä –¥–ª—è –∞—É–¥–∏–æ
		function createAudioPlayer(audioData) {
			if (!audioData) return '';
			
			const fileName = audioData.name || '–ê—É–¥–∏–æ —Ñ–∞–π–ª';
			const fileSize = formatFileSize(audioData.size || 0);
			
			return `
				<div class="audio-player">
					<div class="audio-info">
						<span class="audio-icon">üéµ</span>
						<div>
							<div class="audio-title">${fileName}</div>
							<div style="font-size: 12px; color: #6c757d;">${fileSize}</div>
						</div>
					</div>
					<audio controls preload="metadata">
						<source src="${audioData.data}" type="${audioData.mime || 'audio/mpeg'}">
						–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ
					</audio>
					<div style="margin-top: 8px; font-size: 12px; color: #6c757d; text-align: center;">
						üîä –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
					</div>
				</div>
			`;
		}

		// –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
		function formatFileSize(bytes) {
			if (bytes === 0) return '0 –ë';
			const k = 1024;
			const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë'];
			const i = Math.floor(Math.log(bytes) / Math.log(k));
			return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
		}

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit'
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const joinParam = urlParams.get('join');
            
            if (joinParam) {
                document.getElementById('wallInput').value = decodeURIComponent(joinParam);
                joinWall(decodeURIComponent(joinParam));
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        setTimeout(checkUrlParams, 1000);

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
        window.createWall = createWall;
        window.joinWall = joinWall;
        window.addPost = addPost;
        window.copyWallId = copyWallId;
        window.copyMagnet = copyMagnet;
        window.showShareModal = showShareModal;
        window.closeModal = closeModal;
        window.copyFullMagnet = copyFullMagnet;
        window.copyInviteLink = copyInviteLink;
        window.generateInviteLink = generateInviteLink;
        window.refreshPeers = refreshPeers;
		window.showDeletePostConfirm = showDeletePostConfirm;
		window.showClearDataConfirm = showClearDataConfirm;
		window.showDeleteWallConfirm = showDeleteWallConfirm;
		window.sharePost = sharePost;
		window.confirmAction = confirmAction;
    </script>
	
	<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
	<div id="confirmModal" class="confirm-modal">
		<div class="confirm-content">
			<h3 id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
			<p id="confirmMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
			<div class="confirm-buttons">
				<button onclick="confirmAction(true)" class="confirm-btn yes">–î–∞</button>
				<button onclick="confirmAction(false)" class="confirm-btn no">–ù–µ—Ç</button>
			</div>
		</div>
	</div>
</body>
</html>